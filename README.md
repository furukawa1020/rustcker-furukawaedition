# Rustker Desktop (æ—§ç§°: HATAKE Desktop)

Rustker Desktopã¯ã€Windowsç’°å¢ƒãŠã‚ˆã³WSL2å‘ã‘ã«ç‰¹åŒ–ã—ãŸã€è»½é‡ãƒ»é«˜é€Ÿã‹ã¤å³æ ¼ãªä»•æ§˜ã«æº–æ‹ ã—ãŸ **Docker Desktopã®ä»£æ›¿ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³** ã§ã™ã€‚
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆ`rustkerd`ï¼‰ã‹ã‚‰ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®GUIé€£æºã«è‡³ã‚‹ã¾ã§ã€ã™ã¹ã¦ã‚’ã‚¼ãƒ­ã‹ã‚‰ **Rust** ã§æ§‹ç¯‰ã™ã‚‹ã“ã¨ã§ã€æ¥µé™ã¾ã§ãƒªã‚½ãƒ¼ã‚¹æ¶ˆè²»ã‚’æŠ‘ãˆãŸå¿«é©ãªã‚³ãƒ³ãƒ†ãƒŠé–‹ç™ºç’°å¢ƒã‚’æä¾›ã—ã¾ã™ã€‚

---

## ğŸ’ ãªãœ Rust ãªã®ã‹ï¼Ÿ (Rustkerã®ã‚¢ãƒ‰ãƒãƒ³ãƒ†ãƒ¼ã‚¸ã¨å®Ÿè£…ä¾‹)

ã‚³ã‚¢ã‚¨ãƒ³ã‚¸ãƒ³ã‚’Rustã§æ§‹ç¯‰ã—ãŸã“ã¨ã«ã‚ˆã‚Šã€å¾“æ¥ã®Goè¨€èªãƒ™ãƒ¼ã‚¹ï¼ˆDocker/Mobyï¼‰ã‚„Electronãƒ™ãƒ¼ã‚¹ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã«æ¯”ã¹ã¦ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®åŒæ–¹ã§åœ§å€’çš„ãªå„ªä½æ€§ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

### 1. ğŸš€ åœ§å€’çš„ãªçœãƒªã‚½ãƒ¼ã‚¹ã¨èµ·å‹•ã®é€Ÿã•
Docker Desktopã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã ã‘ã§æ•°GBã®ãƒ¡ãƒ¢ãƒªã‚’æ¶ˆè²»ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ãŒã€Rustkerã¯ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚¿ï¼ˆGCï¼‰ã‚’æŒãŸãªã„ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒã‚¤ãƒŠãƒªã§ã™ã€‚ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ³ãŒæ¶ˆè²»ã™ã‚‹ãƒ¡ãƒ¢ãƒªã¯ **ã‚ãšã‹æ•°åMB** ã«åã¾ã‚Šã€èµ·å‹•ã‚‚ä¸€ç¬ã§ã™ã€‚PCã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ä¸€åˆ‡çŠ ç‰²ã«ã—ã¾ã›ã‚“ã€‚

### 2. ğŸ›¡ï¸ å‹å®‰å…¨ãªã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ (FSM) ã«ã‚ˆã‚‹å®Œå…¨ãªå …ç‰¢æ€§
ã‚³ãƒ³ãƒ†ãƒŠã®ç®¡ç†ã«ã¯è¤‡é›‘ãªçŠ¶æ…‹é·ç§»ï¼ˆCreated -> Running -> Stopped -> Deletedï¼‰ãŒä¼´ã„ã¾ã™ã€‚
Rustkerã§ã¯ã€ã“ã‚Œã‚‰ã®ãƒ«ãƒ¼ãƒ«ã‚’ã€Œå®Ÿè¡Œæ™‚ã®ifæ–‡ã€ã§ã¯ãªãã€**ã€Œã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã®å‹ã®é•ã„ï¼ˆState Patternï¼‰ã€** ã¨ã—ã¦å¼·åˆ¶ã—ã¦ã„ã¾ã™ã€‚

**âœ¨ å®Ÿè£…ä¾‹: çŠ¶æ…‹å‹ã®å®šç¾©ã¨é·ç§»ãƒ­ã‚¸ãƒƒã‚¯**
```rust
// çŠ¶æ…‹ã”ã¨ã«ç‹¬ç«‹ã—ãŸå‹ã¨ã—ã¦å®šç¾©ã™ã‚‹
pub struct Created;
pub struct Running;
pub struct Stopped;

// ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã‚’ä½¿ã£ãŸã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³
pub struct Container<State> {
    pub id: String,
    pub marker: std::marker::PhantomData<State>,
}

impl Container<Created> {
    // CreatedçŠ¶æ…‹ã®ã‚³ãƒ³ãƒ†ãƒŠã—ã‹ start() ã‚’å‘¼ã³å‡ºã›ãªã„ï¼
    pub fn start(self) -> Container<Running> {
        Container {
            id: self.id,
            marker: std::marker::PhantomData,
        }
    }
}

impl Container<Running> {
    // å®Ÿè¡Œä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠã—ã‹ stop() ã‚’å‘¼ã³å‡ºã›ãªã„ï¼
    pub fn stop(self) -> Container<Stopped> {
        Container {
            id: self.id,
            marker: std::marker::PhantomData,
        }
    }
}
```
> ã“ã‚Œã«ã‚ˆã‚Šã€ã€Œæ—¢ã«åœæ­¢ã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ã—ã‚ˆã†ã¨ã™ã‚‹ã€æ“ä½œã¯ãã‚‚ãã‚‚ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒé€šã‚‰ãªã„ãŸã‚ã€æœ¬ç•ªç’°å¢ƒã§Nilãƒã‚¤ãƒ³ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã‚„çŠ¶æ…‹ç•°å¸¸ãƒã‚°ãŒ**æ§‹é€ çš„ã«ç™ºç”Ÿã—ã¾ã›ã‚“ã€‚**

### 3. ğŸ”Œ Windows Win32 APIã¸ã®ä½ãƒ¬ãƒ™ãƒ«çµåˆã¨ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†
Rustkerã¯Windowsä¸Šã§ãƒã‚¤ãƒ†ã‚£ãƒ–ã«å‹•ä½œã—ãªãŒã‚‰ã€WSL2ä¸Šã®Linuxãƒ—ãƒ­ã‚»ã‚¹ï¼ˆ`wsl.exe`ï¼‰ã‚’ç›´æ¥æ“ä½œã—ã¾ã™ã€‚Rustã®å¼·åŠ›ãªFFIã¨ `windows-rs` ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€C++ã¨åŒç­‰ã®ä½ãƒ¬ãƒ™ãƒ«ãªã‚·ã‚¹ãƒ†ãƒ ãƒãƒƒã‚¯ã‚’å®‰å…¨ã«è¡Œãˆã¾ã™ã€‚

ä¾‹ãˆã°ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’å¼·åˆ¶åœæ­¢ã•ã›ã‚‹éš›ã€`wsl.exe` ãƒ—ãƒ­ã‚»ã‚¹ã¨ãã®å­ãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ï¼ˆãƒ—ãƒ­ã‚»ã‚¹ãƒ„ãƒªãƒ¼ï¼‰ã‚’ç¢ºå®Ÿã«çµ‚äº†ã•ã›ã‚‹ãŸã‚ã« **Win32 APIï¼ˆCreateToolhelp32Snapshotï¼‰** ã‚’ç›´æ¥å©ã„ã¦ã„ã¾ã™ã€‚

**âœ¨ å®Ÿè£…ä¾‹: Win32 APIã«ã‚ˆã‚‹ãƒ—ãƒ­ã‚»ã‚¹ãƒ„ãƒªãƒ¼ã®ãƒˆãƒ©ãƒãƒ¼ã‚¹**
```rust
use windows::Win32::System::Diagnostics::ToolHelp::{
    CreateToolhelp32Snapshot, Process32First, Process32Next, PROCESSENTRY32, TH32CS_SNAPPROCESS,
};
use windows::Win32::Foundation::HANDLE;

pub fn get_child_processes(parent_pid: u32) -> Vec<u32> {
    let mut children = Vec::new();
    unsafe {
        let snapshot: HANDLE = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0).unwrap();
        let mut entry = PROCESSENTRY32 {
            dwSize: std::mem::size_of::<PROCESSENTRY32>() as u32,
            ..Default::default()
        };

        if Process32First(snapshot, &mut entry).is_ok() {
            loop {
                // è¦ªPIDãŒä¸€è‡´ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ¢ã™
                if entry.th32ParentProcessID == parent_pid {
                    children.push(entry.th32ProcessID);
                }
                if Process32Next(snapshot, &mut entry).is_err() {
                    break;
                }
            }
        }
    }
    children
}
```

### 4. ğŸ“‚ OSã®é•ã„ã‚’å¸åã™ã‚‹é«˜åº¦ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­è¨ˆ
ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆtarï¼‰ã‚’å±•é–‹ã™ã‚‹éš›ã€Linuxã«ã¯å­˜åœ¨ã—ã¦Windowsã«å­˜åœ¨ã—ãªã„æ¦‚å¿µï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã§ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‹ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ãªã©ï¼‰ãŒã‚¨ãƒ©ãƒ¼ã®å¼•ãé‡‘ã«ãªã‚Šã¾ã™ã€‚
Rustkerã®ã‚«ã‚¹ã‚¿ãƒ Image Storeã¯ã€è§£å‡æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’åˆ©ç”¨ã—ã¦ã€ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«ã€Œã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’å†å¸°çš„ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã€ã¨ã„ã†ç‹¬è‡ªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’çµ„ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚

**âœ¨ å®Ÿè£…ä¾‹: ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã®å®‰å…¨ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å±•é–‹**
```rust
// tarã®è§£å‡ãƒ«ãƒ¼ãƒ—å†…ã§Linkã«é­é‡ã—ãŸå ´åˆ
if etype == tar::EntryType::Symlink {
    deferred_links.push(path); // ä¸€æ—¦ä¿æŒã—ã¦å¾Œå›ã—ã«ã™ã‚‹
    continue;
}

// ã€œä¸­ç•¥ã€œ

// Pass 2: Windowså‘ã‘ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒªãƒ³ã‚¯å…ˆã®å®Ÿä½“ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†å¸°ã‚³ãƒ”ãƒ¼ï¼‰
for link in deferred_links {
    let resolved_target = resolve_symlink_target(&link);
    if resolved_target.is_file() {
        std::fs::copy(&resolved_target, &link.absolute_path)?;
    } else if resolved_target.is_dir() {
        copy_dir_all(&resolved_target, &link.absolute_path)?;
    }
}
```

### 5. ğŸ¨ Tauriã«ã‚ˆã‚‹ä¿¡ã˜ã‚‰ã‚Œãªã„ã»ã©è»½ã„GUI
å·¨å¤§ãªChromiumãƒ–ãƒ©ã‚¦ã‚¶ã‚’ä¸¸ã”ã¨å†…åŒ…ã™ã‚‹Electronã®ä»£ã‚ã‚Šã« **Tauri** ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€OSæ¨™æº–ã®WebViewï¼ˆEdge WebView2ï¼‰ã‚’åˆ©ç”¨ã—ã€IPCé€šä¿¡ï¼ˆãƒ—ãƒ­ã‚»ã‚¹é–“é€šä¿¡ï¼‰ã®ãƒ–ãƒªãƒƒã‚¸ã‚’Rustã§å‡¦ç†ã™ã‚‹ãŸã‚ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã®ã‚µã‚¤ã‚ºãŒæ•°åMBå˜ä½ã«åã¾ã‚Šã€UIã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚‚æ¥µã‚ã¦è»½å¿«ã«è¡Œã‚ã‚Œã¾ã™ã€‚

---

## å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½
- å®Œå…¨ãªã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç† (Create, Start, Stop, Delete)
- ã‚³ãƒ³ãƒ†ãƒ³ãƒˆã‚¢ãƒ‰ãƒ¬ãƒƒã‚µãƒ–ãƒ«ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ãƒˆã‚¢ (Docker Hubã‹ã‚‰ `alpine` ç­‰ã‚’ãƒã‚¤ãƒ†ã‚£ãƒ–Pull)
- ãƒ›ã‚¹ãƒˆã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒŠã¸ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒã‚¦ãƒ³ãƒˆ (`-v`) & ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
- éš”é›¢ã•ã‚ŒãŸã‚«ã‚¹ã‚¿ãƒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ä½œæˆã¨ã‚¢ã‚¿ãƒƒãƒ
- WSLã®ãƒã‚¤ãƒ†ã‚£ãƒ– **UTF-16** å‡ºåŠ›ã«å¯¾å¿œã—ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ»ãƒ©ã‚¤ãƒ–ãƒ­ã‚°ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
- `rustker_compose` ã‚¯ãƒ¬ãƒ¼ãƒˆã«ã‚ˆã‚‹ãƒã‚¤ãƒ†ã‚£ãƒ–ãª Docker Compose ãƒ‘ãƒ¼ã‚¹ã¨ãƒãƒ«ãƒã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
- ãƒ¢ãƒ€ãƒ³ã§ç›´æ„Ÿçš„ãªãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰GUI (Tauri + React)

## ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

1. **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ³ (`rustkerd`) ã®ãƒ“ãƒ«ãƒ‰**
   ```powershell
   cargo build --release --bin rustkerd
   ```
2. **ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒã‚¤ãƒŠãƒªï¼ˆã‚µã‚¤ãƒ‰ã‚«ãƒ¼ï¼‰ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**
   ```powershell
   cd desktop
   .\setup-binaries.ps1
   ```
3. **Tauri ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ï¼ˆGUIï¼‰ã®ãƒ“ãƒ«ãƒ‰**
   ```powershell
   npm install
   npm run tauri build
   ```
   *ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã™ã‚‹ã¨ã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ï¼ˆ`.msi` ãŠã‚ˆã³ `.exe`ï¼‰ãŒ `desktop/src-tauri/target/release/bundle/msi/` ã«ç”Ÿæˆã•ã‚Œã¾ã™ã€‚*
